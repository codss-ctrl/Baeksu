{% extends 'layout.html' %}
<meta charset="UTF-8">
{% block content %}

<script src="js/jquery-3.5.1.js"></script>
<script src="https://developers.kakao.com/sdk/js/kakao.js"></script>
<script type="text/javascript">

Kakao.init('fc6130c6feab0dfdc23efb0bbb610907'); //발급받은 키 중 javascript키를 사용해준다.
console.log(Kakao.isInitialized()); // sdk초기화여부판단
//카카오로그인

var mem_id = ""
var mem_name = ""

function kakaoLogin() {
    Kakao.Auth.login({
      success: function (response) {
        Kakao.API.request({
          url: '/v2/user/me',
          success: function (response) {
        	  console.log(response),
        	  mem_id = response.id,
        	  mem_name = response.properties.nickname,
        	  kakao_fn_login(mem_id);
          },
          fail: function (error) {
            console.log(error)
            kakao_fn_login(mem_id);
          },
        })
      },
      fail: function (error) {
        console.log(error)
	    kakao_fn_login(mem_id);
      },
    })
    kakao_fn_login(mem_id);
  }


//카카오회원 login
	function kakao_fn_login(mem_id){
		
		console.log("kakao_fn_login"+mem_id)
		var param = "";
		param += "dummy=" + Math.random();
		param += "&mem_id="+mem_id; 
		
		$.ajax({
			url : "kakao_join.ajax",
			data : param,
			dataType : "json",
			type : "post",
			async: false,
			success : function(data) {
				if(data.msg == "ok"){
					location.href="main_view?mem_id="+mem_id;
					alert("로그인 성공");
				} else {
					location.href="main_view?mem_id="+mem_id;
					alert("회원가입 실패")
				}
			}
		});
	}

  
  
//카카오로그아웃  
function kakaoLogout() {
    if (Kakao.Auth.getAccessToken()) {
      Kakao.API.request({
        url: '/v1/user/unlink',
        success: function (response) {
        	console.log(response)
        	console.log(response.id)
        },
        fail: function (error) {
          console.log(error)
        },
      })
      Kakao.Auth.setAccessToken(undefined)
    }
    alert("로그아웃 완료되었습니다.")
  }  



	function fn_login(){
		var mem_id = $("#mem_id").val();
		var mem_pass = $("#mem_pass").val();
		
		var param = "";
		param += "dummy=" + Math.random();
		param += "&mem_id="+mem_id;
		param += "&mem_pass="+mem_pass;
		
		$.ajax({
			url : "login.ajax",
			data : param,
			dataType : "json",
			type : "post",
			async: false,
			success : function(data) {
				if(data.msg == "ok"){
					location.href="main_view?mem_id="+mem_id;
				} else if(data.msg == "out") {
					alert("탈퇴한 회원입니다.");
					location.reload();
				} else if(data.msg == "login_err") {
					alert("아이디 혹은 비밀번호가 맞지 않습니다.");
					location.reload();
				} else if(data.msg == "admin") {
					alert("관리자님 환영합니다.");
					location.href="set_view";
				} else if(data.msg == "blind"){
					alert("비활성화된 회원입니다. \n건의사항에 아이디와 이메일을 남겨주시면 이메일로 답변드리겠습니다.");
					location.reload();
				} else {
					alert("아이디 혹은 비밀번호가 맞지 않습니다.");
					location.reload();
				}
			}
		});
	}
</script>
<style>
	 * {
	 	text-decoration: none;
	 	text-align: center;
	 }
	
	#login_form {
		margin : 200px auto;
		height: auto;
		width : 80%; 
		border-collapse: collapse;
 	}
	
	.join_info {
		font-size: 10px;
		color: #888888;
	}
	
	.login_button {
		font-size: 12px;
		cursor: pointer;
		background-color: white;
		color: black;
		border: 1px solid #888888;
	}
			
</style>


  <div>
	<form action="">
	 <table id="login_form">
	  <tr>
	   <td>
		  <input type="text" name="mem_id" id="mem_id" placeholder="ID" value="python"/><br />
	   </td>
	  </tr>
	  <tr>
	   <td>
		  <input type="password" name="mem_pass" id="mem_pass" placeholder="PASSWORD"  value="python0428"/><br />
	   </td>
	  </tr>
	  
	  <tr>
	   <td>
		  <input class="login_button" type="button" onclick="fn_login()" value="로그인" /><br />
		  <input class="login_button" type="button" onclick="kakaoLogin()" value="카카오 로그인" />
		  <input class="login_button" type="button" onclick="kakaoLogout()" value="카카오 로그아웃" /><br />
	   </td>
	  </tr>
	  <tr>
	   <td>
		  <span class="join_info"><a href="join">회원가입</a></span><br/>
		  <span class="join_info"><a href="find_info">아이디&비밀번호찾기</a></span>
	   </td>
	  </tr>
	  
	 </table>
	</form>
  </div>
 
  
{% endblock %} 
 