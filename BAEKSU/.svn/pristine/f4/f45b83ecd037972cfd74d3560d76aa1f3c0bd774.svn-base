{% extends 'layout.html' %}
<meta charset="UTF-8">
{% block content %}

<link rel="stylesheet" href="css/common.css">
<script src="js/jquery-3.5.1.js"></script>
<script>
	var res = ""
	var isRecognizing = false;
	
	if ('SpeechRecognition' in window) {
		console.log("ìŒì„±ì¸ì‹ì„ ì§€ì›í•˜ëŠ” ë¸Œë¼ìš°ì €ì…ë‹ˆë‹¤.")
	}
	
	try {
		var recognition = new (window.SpeechRecognition || window.webkitSpeechRecognition || window.mozSpeechRecognition || window.msSpeechRecognition)();
	} catch(e){
		console.error(e);
	}
	
	recognition.lang = 'ko-KR';  
	recognition.interimResults = false;
	recognition.maxAlternatives = 5;
	//recognition.continuous = true;

	function speech_to_text(){
		recognition.start();
		isRecognizing = true;

		recognition.onstart = function(){
			console.log("ìŒì„±ì¸ì‹ì´ ì‹œì‘ ë˜ì—ˆìŠµë‹ˆë‹¤. ì´ì œ ë§ˆì´í¬ì— ë¬´ìŠ¨ ë§ì´ë“  í•˜ì„¸ìš”.")
		}
		recognition.onresult = function(event) {
			console.log('You said: ', event.results[0][0].transcript);
			var resText = "<br/>[ë‚˜ì˜ ë‹µë³€] <br/> " + event.results[0][0].transcript;
			$('#my_answer').html(resText)
		};

		recognition.onend = function(){
			isRecognizing = false;
		}
	}

	function fn_show(){
		$("#bot_info").hide(); 
		$("#chatbox").show(); 
		random_question();
	}
	
	function save_answer(){
		var bot_question_seq = $('#bot_question_seq').val()
		var my_answer = $('#my_answer').text()
		
		if (my_answer == ''){
			my_answer = 'ë‹µë³€í•˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.'
		}
		
		var param = "";
		param += "dummy=" + Math.random();
		param += "&bot_question_seq="+bot_question_seq;
		param += "&my_answer="+my_answer;
		
		console.log(param)
		
		$.ajax({
			url : "bot_answer.ajax",
			data : param,
			dataType : "json",
			type : "get",
			async: false,
			statusCode : {
				404 : function() {
					alert("ë„¤íŠ¸ì›Œí¬ê°€ ë¶ˆì•ˆì •í•©ë‹ˆë‹¤. ë‹¤ì‹œ ì‹œë„ë¶€íƒë“œë¦½ë‹ˆë‹¤.");
				}
			},
			success : function(data) {
				if(data.msg == "ok"){
					alert("ë‹µë³€ ì €ì¥ ì™„ë£Œ");
					$('#my_answer').text(" ");
					random_question();
				} else {
					alert("ì €ì¥ ë„ì¤‘ ë¬¸ì œê°€ ìƒê²¼ìŠµë‹ˆë‹¤. ê´€ë¦¬ìì—ê²Œ ë¬¸ì˜í•´ì£¼ì„¸ìš”.");
				}
			}
		});
		//location.reload();
	}

	lastres = "";
	function random_question(){
		var q_seq_arr = []
		var q_ask_arr = []
		
		{% for i in questions %}
			q_seq_arr.push('{{i.intrvw_seq}}')
			q_ask_arr.push('{{i.intrvw_content}}')
		{% endfor %}
		
		var ram_n = Math.floor(Math.random()*q_ask_arr.length);
		lastres = q_ask_arr[ram_n];
		$("#bot_question").html(lastres);
		$("#bot_question_seq").val(q_seq_arr[ram_n]);
		speak();
	} 

	function speak(opt_prop) {
		console.log(speak)
		var str = "ë©´ì ‘ì„ ì‹œì‘í•©ë‹ˆë‹¤"
		if (typeof SpeechSynthesisUtterance === "undefined" || typeof window.speechSynthesis === "undefined") {
			alert("ì´ ë¸Œë¼ìš°ì €ëŠ” ìŒì„± í•©ì„±ì„ ì§€ì›í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.")
			return
		}
        
		window.speechSynthesis.cancel() // í˜„ì¬ ì½ê³ ìˆë‹¤ë©´ ì´ˆê¸°í™”

		const prop = opt_prop || {}

		const speechMsg = new SpeechSynthesisUtterance()
		speechMsg.rate = prop.rate || 1 // ì†ë„: 0.1 ~ 10      
		speechMsg.pitch = prop.pitch || 1 // ìŒë†’ì´: 0 ~ 2
		speechMsg.lang = prop.lang || "ko-KR"
		speechMsg.text = lastres
        
		// SpeechSynthesisUtteranceì— ì €ì¥ëœ ë‚´ìš©ì„ ë°”íƒ•ìœ¼ë¡œ ìŒì„±í•©ì„± ì‹¤í–‰
		window.speechSynthesis.speak(speechMsg)
		lastres = ""
    }
           
	$(document).ready(function(){ 
		$("#chatbox").hide(); 
		const selectLang = document.getElementById("select-lang")
		const text = document.getElementById("text")
		var str = "ë©´ì ‘ì„ ì‹œì‘í•©ë‹ˆë‹¤"
	
		speak(str.text, {
    		rate: 1,
    		pitch: 1.2,
    		lang: selectLang.options[selectLang.selectedIndex].value
		})
	})
	
	
	
</script>

<table id="chatbox">
	<tr>
		<td>
			<span id="bot_question"></span>
			<input id="bot_question_seq" type="hidden" />
		</td>
	</tr>
	<tr>
		<td>
			<img id="mike_img" src="image/mike.jpg" width='100px' border='0' onclick="javascript:speech_to_text()"><span id="bot_question"></span>
		</td>
	</tr>
	<tr>
		<td>
			<span id="bot_tel">*ë‹µë³€ì„ ì½ê³  ì˜ ìƒê°í•´ ë³¸ ë’¤ ë§ˆì´í¬ë¥¼ ëˆŒëŸ¬ ì§ˆë¬¸ì— ë‹µë³€í•˜ì„¸ìš”.</span><br/>
			<span id="my_answer"></span>
		</td>
	</tr>
	<tr>
		<td>
		 	<input type="button" class="bot_button" value="ğŸ¥°ë‚´ ë‹µë³€ ì €ì¥í•˜ê¸°" onclick="save_answer()"> 
		 	<input type="button" class="bot_button" value="ì§ˆë¬¸ë°”ê¾¸ê¸°ğŸ¥°" onclick="random_question()">
		</td>
	</tr>
</table>

<div id="bot_info">
	<img src="image/bot_003.png" width="200px">
	<br /> 
	<br /> ì•ˆë…•í•˜ì„¸ìš”. 
	<br /> ë‹¹ì‹ ì˜ ë°±ì „ì·¨ì—…ì„ í•¨ê»˜ ì¤€ë¹„í• 
	<br /> ë©´ì ‘ë´‡ í™í•©êµ¬ì´ ì…ë‹ˆë‹¤.
	<br /> ë‹¹ì‹ ì€ ì¤€ë¹„ëœ ì¸ì¬! ì˜¤ëŠ˜ë„ í˜ë‚´ì„¸ìš”!
	<br /> 
	<br /> 
	<input type="button" class="bot_button" value="ì‹œì‘í•˜ê¸°" onclick="javascript:fn_show()"><br />
</div>

{% endblock %}